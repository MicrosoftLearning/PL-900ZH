---
lab:
    title: '实验室：Power Automate'
    module: '模块 4: Power Automate 入门'
---

# 模块 4: Power Automate 入门
## 实验室：Power Automate

应用场景
========

贝洛斯学院 (Bellows College) 是一所教育机构，校园内有多座建筑。当前，校园访客被记录在纸质日记中。无法始终如一地捕获信息，也无法收集和分析有关整个校园的访问数据。 

校园管理部门希望对其访客登记系统进行现代化改造，在该系统中，由安全人员控制对建筑物的访问，并且所有访问都必须由其主持人预先登记和记录。

在整个课程中，你将生成应用程序并执行自动化，以使 Bellows College 的管理和安全人员可以管理和控制校园建筑的出入情况。 

在本实验室中，你将创建 Power Automate 流以自动化校园管理的各个部分。 

高级实验室步骤
======================

以下内容已被确定为完成项目必须实现的要求：

* 必须在每位访客开始访问前向其分配唯一代码。
* 安全人员需要接收超过预定时间的访客的通知。

## 先决条件

* 完成实验室 1 - 数据建模
* 在实验室 2 第 1 部分中创建的 Campus Staff 应用 – 画布应用（用于测试）

开始前要考虑的事项
-----------------------------------

-   访客代码最合适的分配机制是什么。
-   如何衡量逾期并执行严格的政策。

练习 1：创建访问通知流
===============================

**目标：** 在本练习中，你将创建一个实现要求的 Power Automate 流。访客通知是使用电子邮件完成的。通知包括分配给该访问的唯一代码。

任务 \#1：创建流
---------------------------

1.  打开校园管理解决方案。

    -   登录至 <https://make.powerapps.com>

    -   选择你的 **“环境”。**

    -   选择 **“解决方案”**。

    -   单击打开 **“校园管理”** 解决方案。

2.  请单击 **“新建”**，然后选择 **“流”**。这将在“新建”窗口中打开流编辑器。

3. 搜索 **“当前”**，然后选择 **“Common Data Service（当前环境）”** 连接器。

4. 选择触发器 **“创建记录时”**， 然后选择 **“已更新”** 或 **“已删除”**。

   * 为 **“触发条件”** 选择 **“创建”**
   * 为 **“实体名称”** 选择 **“访问”**
   * 为 **“范围”** 选择 **“组织”**

5.  单击 **“新建步骤”**。需要此步骤来检索访客信息，包括电子邮件。

6. 搜索 **“当前”**，然后选择 **“Common Data Service（当前环境）”** 连接器。

7. 选择 **“获取一个记录”** 操作。 

   * 选择 **“联系人”** 作为 **“实体名称”**
   * 在 **“项目 ID”** 字段中，从动态内容列表中选择 **“访客 (值)”**。

8. 单击 **“新建步骤”**。这是创建并向访客发送电子邮件的步骤。

9. 搜索 *“邮件”*， 选择 **“邮件”** 连接器和 **“发送电子邮件通知”** 操作 
   * 如果要求接受使用此操作的条款和条件，请单击 **“接受”**。
   
   * 选择 **“发件人”** 字段，再从动态内容列表中选择 **“电子邮件”**。

   * 在 **“主题”** 字段，输入 **“你对 Bellows 学院的预定访问”**。

   * 在 **“邮件正文”** 中输入以下文本：  
        *备注：需要将动态内容放置在方括号中命名字段的位置。建议先键入所有文本，然后在正确的位置添加动态内容。*

   ```
    尊敬的 {名字}，

    你目前计划从 {计划开始时间} 到 {计划结束时间} 访问 Bellows 校园。

    你的安全代码为 {代码}，请不要将其共享。你将需要在访问期间出示此代码。


    致敬，

    校园管理处
    Bellows 学院
   ```
   
10.  选择顶部的 **“无标题”** 流名称，并将其重命名为 **“访问通知”**

11.  按下 **“保存”**

任务 \#2：验证并测试流
--------------------------------

1.  打开创建的**校园职工**应用 
2.  按 + 添加新的访问记录
3.  输入所需信息，然后按 **“保存”**
4.  打开流，找到并打开最新的 **“运行”**
5.  打开 **“邮件”** 步骤，并验证是否正确生成了电子邮件内容。

# 练习 2：创建安全扫描流

**目标：** 在本练习中，你将创建一个实现要求的 Power Automate 流。每 15 分钟执行一次安全扫描，如果任何访客超过了预定时间，则会发送安全通知。

## 任务 #1：创建流以检索记录

1. 打开校园管理解决方案。

   -   登录至 <https://make.powerapps.com>

   -   选择你的 **“环境”。**

   -   选择 **“解决方案”**。

   -   单击打开 **“校园管理”** 解决方案。

2. 请单击 **“新建”**，然后选择 **“流”**。这将在“新建”窗口中打开流编辑器。

3. 搜索 *“重复周期”*， 选择 **“计划”** 连接器，再选择 **“重复周期”** 触发器。

4. 将 **“间隔”** 设置为 **“15 分钟”**

5. 单击 **“新建步骤”**。搜索 **“当前”**，然后选择 **“Common Data Service（当前环境）”** 连接器。选择 **“列出记录”** 操作。

   * 输入 **“访问”** 作为 **“实体名称”**
   
   * 单击 **“显示高级选项”**

   * 输入以下表达式作为 **“过滤器查询”**

     ```
     statecode eq 0 and bc_actualstart ne null and bc_actualend eq null and Microsoft.Dynamics.CRM.OlderThanXMinutes(PropertyName='bc_scheduledend',PropertyValue=15)
     ```

   要进行细分

   * `statecode eq 0` 过滤活动访问（其中“状态”为“活动”）
   * `bc_actualstart ne null` 将搜索限制为“实际开始时间”存在值的访问，即存在签入
   * `bc_actualend eq null` 将搜索限制在没有签出的访问（“实际结束时间”没有值） 
   * `Microsoft.Dynamics.CRM.OlderThanXMinutes(PropertyName='bc_scheduledend',PropertyValue=15)` 限制访问要在 15 分钟前完成。  

6.  单击 **“新建步骤”**。搜索 **“应用”**， 选择 **“应用到每一个”** 操作 

7.  在 **“从先前的步骤中选择一个输出”** 字段的动态内容中选择 **“值”**。

8.  检索相关记录的建筑物数据

    * 单击循环内的 **“添加操作”**。
    * 搜索 **“当前”**，然后选择 **“Common Data Service（当前环境）”** 连接器。 
    * 选择 **“获取一个记录”** 操作。
    * 单击 **“获取一个记录”** 旁边的 **“...”**，然后选择 **“重命名”**。输入 **GetBuilding** 作为步骤名称
    * 选择 **“建筑”** 作为 **“实体名称”**
    * 从动态内容中选择 **“建筑物 (值)”** 作为 **“项目 ID”**。

9.  检索相关记录的访客数据

    * 单击循环内的 **“添加操作”**。
    * 搜索 **“当前”**，然后选择 **“Common Data Service（当前环境）”** 连接器。 
    * 选择 **“获取一个记录”** 操作。
    * 单击 **“获取一个记录”** 旁边的 **“...”**，然后选择 **“重命名”**。输入 **“GetVisitor”** 作为步骤名称
    * 选择 **“访问”** 作为**实体名称**
    * 从动态内容中选择 **“访客 (值)”** 作为**项 ID**
    
10.  检索相关记录的所有者数据

* 单击循环内的 **“添加操作”**。
* 搜索 **“当前”**，然后选择 **“Common Data Service（当前环境）”** 连接器。 
* 选择 **“获取一个记录”** 操作。
* 单击 **“获取一个记录”** 旁边的 **“...” **，然后选择 **“重命名”**。输入 **“GetUser”** 作为步骤名称
* 选择 **“访问”** 作为**实体名称**
* 从动态内容中选择 **“所有者 (值)”** 作为**项 ID**

11.  从 **“邮件”** 连接中添加 **“发送电子邮件通知”** 操作，使用 **“应用到每个循环”**

12.  在 **“收件人”** 部分输入你的电子邮件地址

13.  在 **“主题”** 字段中输入 “联系人 {**访客 (值)**} 停留过久”。**“访客 (值)”** 是 **“GetVisitor”** 步骤中的动态内容。

14.  在 **“正文”** 字段中输入“它在建筑物 {**名称**} 中进行”。**“名称”** 是 **“GetBuilding”** 步骤中的动态内容。

15.  单击 **“显示高级选项”**。

16.  在 **“GetUser”** 步骤中找到 **“主电子邮件”**，并将其插入“抄送”字段（会议主持人将收到电子邮件的副本）

17.  选择左上角的流名称 **“无标题”**，然后将其重命名为 **“安全扫描”**

16.  按下 **“保存”**

## 任务 2：验证并测试流

1. 找到或创建具有以下特征的访问记录：
   1. 具有活动状态
   2. 预定结束时间是过去的时间（超过 15 分钟）
   3. “实际开始时间”有一个值。
2. 导航到你的解决方案并找到 **“安全扫描”** 流。单击 **“...”**，再单击 **“编辑”**。
3. 当流打开时，单击 **“测试”**。
4. 选择 **“我将执行触发器操作”**。
5. 单击 **“测试”**，再单击 **“运行流”**。
6. 当流竞争时，单击 **“完成”**。 
7. 展开 **“应用到每一个”**，然后展开 **“发送电子邮件通知”** 步骤。检查 **“主题”** 和 **“电子邮件正文”** 的值。展开 **“显示更多”** 并检查 **“抄送”** 值。
8. 导航到解决方案，单击流旁边的 **“...”**，选择 **“关闭”**。这是为了防止流按计划在测试系统上执行。

# 挑战

* 添加生成信息并映射到通知流。
* 你可以为访问代码生成条形码吗？什么时候有用？
* 如何确保电子邮件正文中用户友好的日期格式？
* 是否可以生成一个包含逾期信息的表格，并且只发送一封电子邮件？
