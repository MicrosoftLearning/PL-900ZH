---
lab:
    title: '实验室 02：画布应用，第 2 部分'
    module: '模块 XX：Power Apps 生成'
---

# PL-900：Microsoft Power Platform 基础知识
## 模块 X，实验室 2 – 画布应用 - 第 2 部分

应用场景
========

贝洛斯学院 (Bellows College) 是一所教育机构，校园内有多座建筑。目前，校园访问记录在纸质日报上。无法始终如一地捕获信息，也无法收集和分析有关整个校园的访问数据。 

校园管理部门希望对其访问者登记系统进行现代化改造，在该系统中，由安全人员控制对建筑物的访问，并且所有访问都必须由其主持人预先登记和记录。

在本课程中，你将生成应用程序并执行自动化，以使贝洛斯学院 (Bellows College) 的管理和安全人员可以管理和控制对校园建筑物的访问。 

在本实验室的第 2 部分，你将创建设计并生成一个 Power Apps 画布应用，安全人员将在建筑入口使用该应用来快速确认和登记访问者。

概要实验室步骤
======================

将按照以下大纲设计画布应用：

-   使用手机外形规格创建应用
-   连接到 Common Data Service，将其作为数据源
-   捕获输入（访问者代码）并找到访问者记录
-   配置表单查看器控件以显示访问者信息
-   使用 CDS 视图填充库
-   处理访问者的签入和签出流程


## 先决条件

* 完成实验室 1 - 数据建模

开始前要考虑的事项
-----------------------------------

-   安全管理人员需要快速访问哪些信息？
-   如果访问者代码无效该怎么办
-   如果访问者在计划时间以外到该怎么办 

练习 1：创建安全画布应用
===============================

**目标：** 在本练习中，你将创建一个画布应用。

任务 \#1：创建画布应用
---------------------------

1.  打开校园管理解决方案。

    -   登录至 <https://make.powerapps.com>

    -   选择你的 **“环境”。**

    -   选择 **“解决方案”**。

    -   单击打开 **“校园管理”** 解决方案。
2.  新建画布应用程序

    -   单击 **“新建”**，然后选择 **“应用 \| 画布应用 \| 电话外形规格”**。
        这将在新窗口中打开应用编辑器。
-   如果要创建你的第一个应用，这将要求你设置
        应用的国家/地区。单击 **“开始使用”**。
    -   单击“文件”，然后选择“另存为”。
-   检查是否选择了 **“云”**。为“名称”输入 **Campus Security** 并
        单击 **“保存”**。这将确保在以下情况下不删除更改：
    应用意外关闭。
3.  连接到数据源（访问）
    1.  单击 **“查看 | 数据源”** 
    2.  单击 **“查看所有实体”** 
    3.  选择 **“访问”** 
4.  要保留进行中的工作，请单击 **“文件 | 保存”**，然后按 **“保存”** 

任务 \#2：显示访问者信息
--------------------------------

1.  添加搜索框

    -   选择 **“树视图”** 选项卡
    -   选择 **“Screen1”**。
    -   前往 **“插入”** 选项卡。
    -   单击 **“文本”**，然后选择 **“文本输入”**。
    -   选择 **“默认”** 属性并清除其值。
    -   选择 **“HintText”** 属性并输入 **"Enter visitor code"** 作为值（包括英文双引号）
    -   在树视图中单击控件名称旁边的“...”，然后选择 **“重命名”**，将名称更改为 **textCode**
2. 添加表单视图

   -   在 **“插入”** 选项卡上，单击 **“表单”**，然后选择 **“显示”** 
   -   使用大小句柄将表单放置在搜索文本框下方
   -   选择 **“DataSource”** 属性并输入 **Visits**
   -   在“属性”窗格中，选择 **“水平”** 作为 **“布局”** 
   -   单击 **“编辑字段”** 
   -   单击 **“添加字段”** 并选择以下字段：实际结束时间、实际开始时间、生成、计划结束时间、计划开始时间、访问者
   -   按 **“添加”** 
   -   通过拖动列表中的字段卡来更改所选字段的顺序。推荐顺序为访问者、生成、计划开始时间、计划结束时间、实际开始时间、实际结束时间
   -   选择 **“项目”** 属性，然后输入 `LookUp(Visits, Code = textCode.Text)` 

3.  要保留进行中的工作，请单击 **“文件 | 保存”**，然后按 **“保存”** 

4. 测试应用

   -   切换到包含解决方案的浏览器选项卡
   -   选择 **“访问”** 实体
   -   选择 **“数据”** 选项卡
   -   单击 **“选择视图”**，然后选择 **“所有字段”** 
   -   选择并复制 **“编码”** 列中显示的任何值
   -   切换到应用所在的浏览器选项卡，按 F5 键运行应用
   -   将复制的值粘贴到搜索文本框，验证记录是否显示在表单中
5.  按 **ESC**退出正在运行的应用。


任务 \#3：添加签入和签出按钮
---------------------------------------

1. 将搜索结果保存到变量中以在整个控件中重复使用

   * 选择 **“textCode”** 控件
   * 选择 **“OnChange”** 属性
   * 输入以下表达式 `Set(Visit, LookUp(Visits, Code = textCode.Text))`
     它与上面的表达式相同，只是这次我们将结果保存在全局变量中。这使我们可以在整个应用中使用变量 *Visit*，而无需重新输入整个查找表达式。

2. 添加签入和签出按钮
   
   1. 选择 **“插入”** 选项卡
   2. 单击 **“按钮”** 
   3. 将按钮 **“文本”** 属性改为 **“Check In”** 
   4. 将按钮重命名为 **“CheckInButton”** 
   5. 单击 **“按钮”** 来插入另一个按钮
   6. 将按钮 **“文本”** 属性改为 **“Check Out”** 
   7. 将按钮重命名为 **CheckOutButton**
   8. 将按钮并排放置在记录表单视图下方 
   
3. 根据访问数据启用和禁用按钮。 
   如果已找到访问记录（非空）、记录状态为活动且访问尚未开始（即实际开始值为空），那么我们会启用 **“签入”** 按钮。

   * 选择按钮的 **“DisplayMode”** 属性

   * 在下面输入表达式。

      ```
      If(!IsBlank(Visit) 
      && Visit.Status = 'Status (Visits)'.Active
      && IsBlank(Visit.'Actual Start'),
          DisplayMode.Edit,
          DisplayMode.Disabled
      )
      ```

   该表达式可以按如下方式分解：

   * `!IsBlank(Visit)` - 找到访问记录
   * `&&` - 逻辑 AND 运算符
   * `Visit.Status = 'Status (Visits)'.Active` 记录状态为*“活动”*
   * `IsBlank(Visit.'Actual Start')` - 活动开始字段中没有任何数据

4. 如果已找到访问记录（非空）、记录状态为活动且访问已经开始（即实际开始值为非空），那么我们会启用 **“签出”** 按钮。

   * 选择 **“查看”** 按钮上的 **“DisplayMode”** 属性

   * 在下面输入表达式。

     ```
     If(!IsBlank(Visit) 
     && Visit.Status = 'Status (Visits)'.Active
     && !IsBlank(Visit.'Actual Start'),
         DisplayMode.Edit,
         DisplayMode.Disabled
     )
     ```

5. 要保留进行中的工作，请单击 **“文件 | 保存”**，然后按  **“保存”**。

6. 按 **F5** 以运行应用。两个按钮均应禁用。输入你先前复制的代码值，然后按 **Tab**键，将焦点从文本框移开。 **“签入”** 按钮应变为启动状态。

7. 按 **ESC**退出正在运行的应用。

## 任务 #4：完成签入和签出流程

要执行签入和签出流程，我们需要按如下所示更新 CDS 访问数据：

* 访问者签到时，将*实际开始时间*字段设置为当前日期和时间
* 访问者签出时，将*实际结束时间*字段设置为当前日期和时间。 
* 签出后，将记录状态设置为“不活动”，表明访问已完成

1. 选择 **“签入”** 按钮。

2. 将 **“OnSelect”** 属性设置为以下表达式。

   ```
   Patch(
       Visits,
       Visit,
       {'Actual Start': Now()}
   );
   Refresh([@Visits]);
   Set(Visit, LookUp(Visits, Code = textCode.Text));
   ```

   此表达式包含以下部分：

   * `Patch(Visits, Visit, {'Actual Start': Now()});`. *Patch*方法更新 **Visits** 实体，它是由 **Visits** 变量（当前访问）标识的记录。该表达式将*“实际开始”*字段的值设置为当前日期和时间 (*Now()* 方法）。
   * `Refresh([@Visits]);`.  此表达式在基础值发生更改时刷新访问记录 
   * `Set(Visit, LookUp(Visits, Code = textCode.Text));` 此表达式使用 CDS 中的全新数据更新*访问*变量。

3. 选择 **“签出”** 按钮。

4. 将 **“OnSelect”** 属性设置为以下表达式。

   ```
   Patch(
       [@Visits],
       Visit,
       {
           'Actual End': Now(),
           Status: 'Status (Visits)'.Inactive
       }
   );
   Refresh([@Visits]);
   Set(Visit, LookUp(Visits, Code = textCode.Text));
   ```

   与签入表达式的唯一区别是将 *“Status”* 值设为 *“Inactive”*。

5. 要保留进行中的工作，请单击 **“文件 | 保存”**，然后按  **“保存”**。

6. 按 **F5** 以运行应用。输入你先前复制的代码值，然后按 **Tab**键，将焦点从文本框移开。 **“签入”** 按钮应变为启动状态。

7. 按 **“签入”** 按钮。应该发生以下情况：

   1. *“实际开始时间”* 是当前日期和时间
   2.  **“签入”** 按钮被禁用
   3.  **“签出”** 按钮被启用

8. 按 **“签出”** 按钮。

   1. *“实际结束时间”* 具有当前日期和时间
   2. 两个按钮均被禁用

9. 按 **ESC**退出正在运行的应用。

任务 \#5：添加视觉指示
--------------------------------------

除了文本信息之外，还提供视觉指示时，移动应用的可用性会大大提高。在此任务中，我们将添加一个图标，指示是否可以签入或签出访客。

1. 选择 **“嵌入”** 选项卡

2. 选择 **“图标 | 添加”**。此时，选择哪个图标无关紧要，因为我们希望该值是动态的。

3. 调整图标大小并将其放置在按钮下方的屏幕中间

4. 选择 **“图标”** 属性，然后输入以下表达式

   ```
   If(
      CheckInButton.DisplayMode = DisplayMode.Disabled 
   && CheckOutButton.DisplayMode = DisplayMode.Disabled,
       Icon.EmojiFrown,
       Icon.EmojiSmile
   )
   ```

5. 要保留进行中的工作，请单击 **“文件 | 保存”**，然后按  **“保存”**。
6. 按 **F5**以运行该应用。输入你先前复制的代码值，然后按 **Tab**键，将焦点从文本框移开。验证图标显示皱眉的表情符号。
7. 查找以前未使用过的其他代码值。你可以运行之前创建的 **Campus Staff** 应用来新建访问记录。验证图标是否显示微笑表情符号。
8. 按 **ESC**退出正在运行的应用。

## 任务 6：发布应用

1. 选择 **Campus Security**应用，单击 **“编辑”** 
2. 选择**文件 | 发布** 

# 挑战

* 如何避免手动输入访问代码？
* 为访问添加建筑验证
* 添加访问实际时间与访问计划时间的验证（过早、过晚等）
* 添加访问详细状态，例如电子邮件显示和访问者验证、拒绝访问建筑的原因等
* 在一次校园访问期间，你将如何处理多个建筑/会议/检查的要求。例如，某人可能会访问校园一天，在这一天中将在不同时间会见多个建筑中的工作人员。你会考虑将*约会*实体加入解决方案中吗？